C51 COMPILER V9.54   PWM                                                                   07/01/2016 12:06:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN .\Objects\pwm.obj
COMPILER INVOKED BY: E:\MDK\keil\keilmdk\C51\BIN\C51.EXE pwm.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listi
                    -ngs\pwm.lst) TABS(2) OBJECT(.\Objects\pwm.obj)

line level    source

   1          
   2          #include <math.h>
   3          #include "pwm.h"
   4          #include "pid.h"
   5          extern float  Angle_accY;
   6          extern int Point;
   7          int PWM_MAX =155;//输出值限幅
   8          float zkb=0.0;
   9          
  10          /**********************************
  11          *     配置PWM寄存器               *
  12          ***********************************/
  13          void init_pwm()
  14          {
  15   1          CCON=0x00;
  16   1          CMOD = 0x02; // 设置 PCA 定时器
  17   1          CL = 0x00;//清零
  18   1          CH = 0x00;
  19   1          CCAP0L = 0xFF; //设置低电平50%占空比 8位PWM模式最大为255，一半为128，即0x80 
  20   1          CCAP0H = 0xFF; // 当CL由ff变为00溢出时，CCAP0H装载到CCAP0L中，实现无干扰的更新PWM。
  21   1          CCAPM0 = 0x42; //0100,0010 设置使用8位PWM模式 无中断  
  22   1          //CCAPM0 =0x63;//PCA模块0工作于8位PWM模式 允许比较器功能，允许PWM输出启用CCF0中断 上升沿中断 
  23   1          CR = 1; //开启 PCA 定时器.
  24   1      }
  25          void motor_PWM_Forward(int val)   //
  26          {
  27   1         in2=0;
  28   1         in1=1;
  29   1         pwm(val);
  30   1      }
  31          
  32          void motor_PWM_Backward(int  val)
  33          {
  34   1         in2=1;
  35   1         in1=0;
  36   1         pwm(val);
  37   1      }
  38          
  39          void pwm(unsigned char speed)
  40          {
  41   1          CCAP0L = ~speed;
  42   1          CCAP0H = ~speed;
  43   1          zkb=speed;
  44   1      }
  45          
  46          void MotorMove( long int pwm)
  47          {
  48   1        if(pwm>0)
  49   1          { 
  50   2          pwm=(unsigned char)pwm;          
  51   2          motor_PWM_Forward(pwm);
  52   2          }
  53   1        else if(pwm<0)
  54   1          { 
C51 COMPILER V9.54   PWM                                                                   07/01/2016 12:06:19 PAGE 2   

  55   2          pwm=abs(pwm);
  56   2          pwm=(unsigned char)pwm;     
  57   2          motor_PWM_Backward(pwm);
  58   2          }
  59   1      }
  60          
  61          void Mode_basc(int Angle)
  62          {
  63   1        long int  M1_PWM;
  64   1        PID_SetPoint(Angle);  //设置转动角度
  65   1        PID_Setkp(1.257);//1.557 1.257
  66   1        PID_Setki(0.066);//0.020 0.068
  67   1        PID_Setkd(0);
  68   1        M1_PWM=PID_PosLocCalc(Angle_accY);
  69   1        if(M1_PWM > PWM_MAX)
  70   1          M1_PWM =  PWM_MAX;
  71   1        if(M1_PWM < 18&&M1_PWM>3) 
  72   1          M1_PWM=18;
  73   1        if(M1_PWM < -PWM_MAX)
  74   1          M1_PWM = -PWM_MAX; 
  75   1         if(M1_PWM > -18&&M1_PWM<-3)
  76   1          M1_PWM=-18;
  77   1          if(M1_PWM >= -2&&M1_PWM<=2&&Angle_accY==Angle)
  78   1          M1_PWM=0;
  79   1      
  80   1        MotorMove(M1_PWM);
  81   1      }
  82          
  83          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    465    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
